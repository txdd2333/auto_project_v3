# 运维流程中心 - 用户使用指南

> 版本：v1.0
> 更新时间：2026-01-24

---

## 目录

- [快速开始](#快速开始)
- [角色与权限](#角色与权限)
- [功能使用](#功能使用)
- [工作流前置准备](#工作流前置准备)
- [常见问题](#常见问题)

---

## 快速开始

### 1. 首次登录

**登录地址：** http://your-server-ip（或管理员提供的地址）

**初始账号：**
- 邮箱：由管理员创建并提供
- 密码：由管理员创建并提供

**首次登录后，请立即修改密码：**

1. 登录系统
2. 点击右上角头像
3. 选择"用户设置"
4. 修改密码

---

### 2. 系统架构

```
运维流程中心
├── 模块管理         （组织业务模块）
├── 场景管理         （管理具体场景）
│   ├── SOP 文档     （标准操作规程）
│   ├── 流程图       （可视化流程）
│   └── 工作流       （自动化执行）
├── 工作流管理       （跨场景工作流）
├── 执行日志         （查看执行记录）
├── AI 配置          （配置 AI 模型）
└── 用户管理         （管理用户权限）
```

---

## 角色与权限

### 角色说明

| 角色 | 权限说明 | 典型用户 |
|------|---------|---------|
| **超级管理员** | 全部权限 | IT 负责人 |
| **管理员** | 管理模块、场景、用户 | 部门经理 |
| **用户** | 查看和执行已分配的工作流 | 一线运维人员 |

### 权限矩阵

| 功能 | 超级管理员 | 管理员 | 用户 |
|------|-----------|--------|------|
| 用户管理 | ✅ | ❌ | ❌ |
| 账号审批 | ✅ | ❌ | ❌ |
| AI 配置 | ✅ | ❌ | ❌ |
| 创建模块 | ✅ | ✅ | ❌ |
| 创建场景 | ✅ | ✅ | ❌ |
| 创建工作流 | ✅ | ✅ | ❌ |
| 查看 SOP | ✅ | ✅ | ✅ |
| 执行工作流 | ✅ | ✅ | ✅ |
| 查看执行日志 | ✅ | ✅ | ✅ |

---

## 功能使用

### 1. 模块管理

**什么是模块？**

模块是业务功能的顶层分类，例如：
- 数据库运维
- 服务器运维
- 网络运维
- 应用部署

**如何创建模块：**

1. 进入"模块管理"
2. 点击"新建模块"
3. 填写模块信息：
   - 名称：简短清晰（如"数据库运维"）
   - 描述：详细说明模块用途
4. 点击"保存"

---

### 2. 场景管理

**什么是场景？**

场景是模块下的具体操作场景，例如：
- MySQL 数据库备份
- Nginx 配置更新
- 服务器性能巡检

**如何创建场景：**

1. 进入"模块管理"
2. 选择一个模块
3. 点击"新建场景"
4. 填写场景信息：
   - 所属模块：自动关联
   - 名称：描述具体操作
   - 描述：操作的详细说明
5. 点击"保存"

---

### 3. SOP 文档

**什么是 SOP？**

SOP（Standard Operating Procedure）是标准操作规程，描述如何手工执行某个操作。

**如何编辑 SOP：**

1. 进入某个场景
2. 点击"编辑 SOP"
3. 使用富文本编辑器编写文档：

**支持的格式：**

- ✅ 标题、段落、列表
- ✅ 粗体、斜体、下划线
- ✅ 代码块（带语法高亮）
- ✅ 表格
- ✅ 图片（支持粘贴、拖拽）
- ✅ 超链接

**插入图片的 4 种方式：**

1. **Ctrl+C / Ctrl+V**：从剪贴板粘贴
2. **拖拽**：将图片拖入编辑器
3. **工具栏上传**：点击工具栏的图片按钮
4. **批量上传**：一次上传多张图片

**导出 SOP：**

- 📄 导出为 PDF
- 📝 导出为 Word（.docx）
- 🖼️ 导出为图片（.png）

---

### 4. 流程图

**什么是流程图？**

流程图是 SOP 的可视化表示，帮助理解操作流程。

**支持的编辑器：**

1. **React Flow**（推荐）：
   - 现代化界面
   - 丰富的节点类型
   - 实时预览

2. **LogicFlow**：
   - 专业流程图
   - 支持泳道图

3. **BPMN.js**：
   - 符合 BPMN 2.0 标准
   - 适合复杂流程

4. **Draw.io**：
   - 功能最强大
   - 支持导入/导出

**如何绘制流程图：**

1. 进入某个场景
2. 点击"编辑流程图"
3. 选择编辑器类型
4. 从左侧拖拽节点到画布
5. 连接节点形成流程
6. 保存流程图

---

### 5. 工作流（自动化）

**什么是工作流？**

工作流是将手工操作自动化的脚本，基于 Playwright 技术实现 RPA（机器人流程自动化）。

**工作流的组成：**

```
工作流 = 一系列节点 + 连接线

节点类型：
├── 开始节点
├── 任务节点（普通任务）
├── Playwright 节点（浏览器自动化）
├── API 调用节点
├── 决策节点（条件判断）
├── 延时节点
├── 通知节点
└── 结束节点
```

**工作流编辑器：**

进入"工作流管理" → 点击"新建工作流" → 使用可视化编辑器设计工作流

---

## 工作流前置准备

### 重要说明

**在创建和执行工作流之前，请确保完成以下准备工作：**

---

### 步骤 1：安装 Playwright 浏览器

**为什么需要？**

工作流中的"Playwright 节点"需要浏览器来执行自动化任务（如自动登录、填表、点击等）。

**如何安装：**

```bash
# 在服务器上执行
cd /opt/ops-workflow-center

# 安装所有浏览器
npx playwright install

# 或仅安装 Chromium（推荐）
npx playwright install chromium

# 安装系统依赖（Linux）
npx playwright install-deps
```

**验证安装：**

```bash
npx playwright --version
# 应显示：Version 1.40.1
```

---

### 步骤 2：理解工作流节点

#### 1. 开始节点

- 每个工作流的入口
- 必须有且只能有一个
- 无需配置

#### 2. 任务节点

**用途：** 执行普通任务（如运行 Shell 命令）

**配置示例：**

```json
{
  "type": "task",
  "name": "检查磁盘空间",
  "command": "df -h",
  "timeout": 30000
}
```

#### 3. Playwright 节点（重点）

**用途：** 浏览器自动化操作

**典型场景：**

- 自动登录 Web 系统
- 自动填写表单
- 自动点击按钮
- 自动截图验证

**配置参数：**

| 参数 | 说明 | 示例 |
|------|------|------|
| `url` | 访问的网址 | `https://example.com` |
| `actions` | 操作步骤数组 | 见下方 |
| `headless` | 无头模式 | `true` / `false` |
| `timeout` | 超时时间（毫秒）| `30000` |

**操作类型（actions）：**

| 操作 | 说明 | 示例 |
|------|------|------|
| `click` | 点击元素 | `{ "action": "click", "selector": "#login-btn" }` |
| `fill` | 填写输入框 | `{ "action": "fill", "selector": "#username", "value": "admin" }` |
| `wait` | 等待元素出现 | `{ "action": "wait", "selector": ".success-msg" }` |
| `screenshot` | 截图 | `{ "action": "screenshot", "path": "./result.png" }` |
| `waitForNavigation` | 等待页面跳转 | `{ "action": "waitForNavigation" }` |

**完整示例：自动登录百度**

```json
{
  "type": "playwright",
  "name": "自动登录百度",
  "config": {
    "url": "https://www.baidu.com",
    "headless": false,
    "timeout": 30000,
    "actions": [
      {
        "action": "click",
        "selector": "#s-top-loginbtn",
        "description": "点击登录按钮"
      },
      {
        "action": "wait",
        "selector": "#TANGRAM__PSP_11__userName",
        "timeout": 5000
      },
      {
        "action": "fill",
        "selector": "#TANGRAM__PSP_11__userName",
        "value": "your_username",
        "description": "输入用户名"
      },
      {
        "action": "fill",
        "selector": "#TANGRAM__PSP_11__password",
        "value": "your_password",
        "description": "输入密码"
      },
      {
        "action": "click",
        "selector": "#TANGRAM__PSP_11__submit",
        "description": "点击登录"
      },
      {
        "action": "wait",
        "selector": ".s_username_top",
        "timeout": 10000,
        "description": "等待登录成功"
      },
      {
        "action": "screenshot",
        "path": "./login_success.png",
        "description": "截图验证"
      }
    ]
  }
}
```

#### 4. API 调用节点

**用途：** 调用 REST API

**配置示例：**

```json
{
  "type": "api",
  "name": "查询服务器状态",
  "config": {
    "method": "GET",
    "url": "https://api.example.com/server/status",
    "headers": {
      "Authorization": "Bearer YOUR_TOKEN"
    },
    "timeout": 10000
  }
}
```

#### 5. 决策节点

**用途：** 根据条件选择不同的执行路径

**配置示例：**

```json
{
  "type": "decision",
  "name": "检查磁盘使用率",
  "config": {
    "condition": "diskUsage > 80",
    "trueLabel": "发送告警",
    "falseLabel": "继续执行"
  }
}
```

#### 6. 延时节点

**用途：** 等待一段时间

**配置示例：**

```json
{
  "type": "delay",
  "name": "等待 5 秒",
  "config": {
    "duration": 5000
  }
}
```

#### 7. 通知节点

**用途：** 发送通知（邮件、企业微信等）

**配置示例：**

```json
{
  "type": "notification",
  "name": "发送完成通知",
  "config": {
    "type": "email",
    "to": "admin@example.com",
    "subject": "任务完成",
    "body": "工作流执行成功"
  }
}
```

---

### 步骤 3：获取元素选择器（Playwright 必备）

**什么是选择器？**

选择器是定位网页元素的方式，类似于地址。

**如何获取选择器：**

**方法 1：使用浏览器开发者工具**

1. 打开目标网页
2. 按 `F12` 打开开发者工具
3. 点击左上角的"选择元素"图标（或按 `Ctrl+Shift+C`）
4. 鼠标移到目标元素上，点击
5. 在"Elements"面板中，右键元素 → Copy → Copy selector

**方法 2：使用 Playwright Inspector**

```bash
# 启动 Playwright Inspector
npx playwright codegen https://example.com

# 这会打开一个浏览器和一个录制窗口
# 你的操作会自动生成代码
```

**常见选择器类型：**

| 类型 | 语法 | 示例 |
|------|------|------|
| ID | `#id` | `#login-btn` |
| Class | `.class` | `.btn-primary` |
| 标签 | `tag` | `button` |
| 属性 | `[attr=value]` | `[type="submit"]` |
| 文本 | `text=xxx` | `text=登录` |
| 组合 | `parent > child` | `form > button` |

---

### 步骤 4：测试工作流

**在正式使用前，请务必测试工作流：**

**测试步骤：**

1. 创建测试工作流
2. 从最简单的节点开始（如访问一个网页）
3. 逐步添加复杂操作
4. 每次添加新节点后立即测试
5. 查看执行日志，排查错误

**调试技巧：**

- 🔧 设置 `headless: false`，可以看到浏览器操作过程
- 🔧 增加 `screenshot` 节点，确认每步是否正确
- 🔧 适当增加 `wait` 或 `delay`，避免操作过快
- 🔧 使用"执行日志"查看详细错误信息

---

### 步骤 5：权限准备

**执行工作流前，确保：**

1. ✅ 你的账号已被管理员分配到相应的场景或工作流
2. ✅ 你的角色有执行权限（管理员或用户）
3. ✅ 工作流状态为"已发布"（不是"草稿"）

**如何查看权限：**

1. 进入"工作流管理"
2. 如果看不到某个工作流，说明你没有权限
3. 联系管理员分配权限

---

### 步骤 6：执行工作流

**准备就绪后，执行工作流：**

1. 进入"工作流管理"
2. 找到目标工作流
3. 点击"执行"按钮
4. 等待执行完成
5. 查看执行日志

**查看执行日志：**

1. 进入"执行日志"页面
2. 找到你的执行记录
3. 查看详细日志、错误信息、截图等

---

## 常见问题

### Q1：忘记密码怎么办？

**答：** 联系管理员重置密码。

---

### Q2：看不到某个模块/场景/工作流？

**答：** 可能原因：
1. 没有被管理员分配权限
2. 对象已被删除
3. 对象状态为"草稿"

**解决：** 联系管理员分配权限或检查对象状态。

---

### Q3：工作流执行失败怎么办？

**答：** 排查步骤：
1. 进入"执行日志"查看错误信息
2. 检查 Playwright 浏览器是否已安装
3. 检查选择器是否正确（网页可能已更新）
4. 检查网络连接（是否能访问目标网站）
5. 联系管理员或技术支持

---

### Q4：SOP 中的图片无法显示？

**答：** 可能原因：
1. 上传失败（检查网络）
2. 文件存储路径错误（联系管理员）
3. 浏览器缓存问题（按 `Ctrl+F5` 强制刷新）

---

### Q5：如何提高工作流执行成功率？

**答：** 最佳实践：
1. ✅ 使用稳定的选择器（优先使用 ID 或 data-* 属性）
2. ✅ 增加适当的等待时间（`wait` 节点）
3. ✅ 添加错误处理节点
4. ✅ 定期维护工作流（目标网站可能会更新）
5. ✅ 保持目标系统稳定（避免在维护时间执行）

---

### Q6：可以同时执行多个工作流吗？

**答：** 可以。系统支持并发执行，但建议：
1. 避免对同一目标系统执行多个工作流
2. 注意系统资源（CPU、内存）
3. 避免在业务高峰期执行大量工作流

---

### Q7：如何导出 SOP 文档？

**答：**
1. 进入场景详情页
2. 点击"导出 SOP"按钮
3. 选择格式（PDF / Word / 图片）
4. 等待下载完成

---

### Q8：工作流可以定时执行吗？

**答：** 当前版本暂不支持定时任务，需要手动执行。

未来版本将支持：
- 定时执行（Cron 表达式）
- 触发器（事件驱动）
- API 调用触发

---

### Q9：AI 配置是什么？

**答：** AI 配置用于集成 AI 模型（如 ChatGPT），用于：
- 智能生成 SOP
- 辅助编写工作流
- 分析执行日志

**注：** 需要管理员配置 AI API 密钥。

---

### Q10：系统支持多少用户同时使用？

**答：** 取决于服务器配置：
- 小型部署（2 核 4G）：10-20 并发用户
- 中型部署（4 核 8G）：50-100 并发用户
- 大型部署（8 核 16G+）：200+ 并发用户

---

## 快速参考卡片

### Playwright 操作速查

| 操作 | 代码示例 |
|------|---------|
| 点击 | `{ "action": "click", "selector": "#btn" }` |
| 输入 | `{ "action": "fill", "selector": "#input", "value": "text" }` |
| 等待 | `{ "action": "wait", "selector": ".msg", "timeout": 5000 }` |
| 截图 | `{ "action": "screenshot", "path": "./img.png" }` |
| 跳转 | `{ "action": "waitForNavigation" }` |

---

### 选择器速查

| 类型 | 语法 | 说明 |
|------|------|------|
| ID | `#id` | 最推荐 |
| Class | `.class` | 常用 |
| 属性 | `[type=submit]` | 稳定 |
| 文本 | `text=登录` | 直观 |
| CSS | `div > button` | 灵活 |

---

## 联系支持

如有问题，请联系：

- 📧 邮箱：support@your-company.com
- 📱 电话：400-xxx-xxxx
- 💬 企业微信：xxx
- 📖 文档：查看 PRODUCTION_DEPLOYMENT.md

---

**祝您使用愉快！**

开始您的自动化之旅吧！
